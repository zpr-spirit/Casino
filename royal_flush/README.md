# CSMAR æ™ºèƒ½è´¢ç»æŠ¥å‘Šåˆ†æå¹³å° API (æ–°ç‰ˆæœ¬)

åŸºäºFastAPIæ„å»ºçš„æ™ºèƒ½è´¢ç»åˆ†æåç«¯æœåŠ¡ï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„é¡¹ç›®ç»“æ„å’Œè®¾è®¡æ¨¡å¼ã€‚

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
royal_flush/
â”œâ”€â”€ app/                              # åº”ç”¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                       # ä¸»åº”ç”¨æ–‡ä»¶
â”‚   â”œâ”€â”€ api/                          # APIå±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ v1/                       # API v1ç‰ˆæœ¬
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ endpoints/            # APIç«¯ç‚¹
â”‚   â”‚           â”œâ”€â”€ __init__.py
â”‚   â”‚           â”œâ”€â”€ stocks.py         # è‚¡ç¥¨åˆ†æç«¯ç‚¹
â”‚   â”‚           â”œâ”€â”€ quantitative.py   # é‡åŒ–åˆ†æç«¯ç‚¹
â”‚   â”‚           â”œâ”€â”€ health.py         # å¥åº·æ£€æŸ¥ç«¯ç‚¹
â”‚   â”‚           â””â”€â”€ depends/          # ä¾èµ–æ³¨å…¥
â”‚   â”‚               â”œâ”€â”€ __init__.py
â”‚   â”‚               â””â”€â”€ common.py
â”‚   â”œâ”€â”€ core/                         # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†
â”‚   â”‚   â””â”€â”€ security.py               # å®‰å…¨ç›¸å…³
â”‚   â”œâ”€â”€ models/                       # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ schemas/                  # æ•°æ®æ¨¡å¼
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ common.py             # é€šç”¨æ¨¡å¼
â”‚   â”‚   â”‚   â”œâ”€â”€ stock.py              # è‚¡ç¥¨ç›¸å…³æ¨¡å¼
â”‚   â”‚   â”‚   â””â”€â”€ quantitative.py       # é‡åŒ–åˆ†ææ¨¡å¼
â”‚   â”‚   â””â”€â”€ entities/                 # å®ä½“æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ stock.py              # è‚¡ç¥¨å®ä½“
â”‚   â”‚       â””â”€â”€ quantitative.py       # é‡åŒ–åˆ†æå®ä½“
â”‚   â”œâ”€â”€ services/                     # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ stock/                    # è‚¡ç¥¨åˆ†ææœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ analysis.py
â”‚   â”‚   â””â”€â”€ quantitative/             # é‡åŒ–åˆ†ææœåŠ¡
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â””â”€â”€ analysis.py
â”‚   â””â”€â”€ utils/                        # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ logger.py                 # æ—¥å¿—å·¥å…·
â”‚       â””â”€â”€ helpers.py                # è¾…åŠ©å‡½æ•°
â”œâ”€â”€ tests/                            # æµ‹è¯•ç›®å½•
â”‚   â”œâ”€â”€ unit/                         # å•å…ƒæµ‹è¯•
â”‚   â””â”€â”€ integration/                  # é›†æˆæµ‹è¯•
â”œâ”€â”€ docs/                             # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ scripts/                          # è„šæœ¬ç›®å½•
â”œâ”€â”€ main.py                           # å¯åŠ¨å…¥å£
â”œâ”€â”€ start_new.py                      # æ–°ç‰ˆæœ¬å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_new_api.py                   # æ–°ç‰ˆæœ¬æµ‹è¯•è„šæœ¬
â”œâ”€â”€ requirements.txt                  # é¡¹ç›®ä¾èµ–
â””â”€â”€ README_NEW.md                     # æ–°ç‰ˆæœ¬è¯´æ˜æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd /home/ryanzhangadmin/quant/Casino/royal_flush
pip install -r requirements.txt
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1: ä½¿ç”¨æ–°ç‰ˆæœ¬å¯åŠ¨è„šæœ¬
python start_new.py

# æ–¹å¼2: ç›´æ¥è¿è¡Œmain.py
python main.py

# æ–¹å¼3: ä½¿ç”¨uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 3. è®¿é—®æœåŠ¡

- **APIæ–‡æ¡£**: http://localhost:8000/docs
- **ReDocæ–‡æ¡£**: http://localhost:8000/redoc
- **å¥åº·æ£€æŸ¥**: http://localhost:8000/health
- **APIä¿¡æ¯**: http://localhost:8000/

## ğŸ“š APIæ¥å£

### è‚¡ç¥¨åˆ†ææ¥å£

#### 1. åˆ†æå•åªè‚¡ç¥¨
```http
POST /api/v1/stocks/analyze
Content-Type: application/json

{
    "stock_code": "000001",
    "market": "a_stock",
    "analysis_type": "basic"
}
```

#### 2. æœç´¢è‚¡ç¥¨
```http
GET /api/v1/stocks/search?query=å¹³å®‰&market=a_stock&limit=10
```

#### 3. è·å–å¸‚åœºè‚¡ç¥¨åˆ—è¡¨
```http
GET /api/v1/stocks/market/a_stock/list
```

### é‡åŒ–åˆ†ææ¥å£

#### 1. è¿è¡Œé‡åŒ–åˆ†æ
```http
POST /api/v1/quantitative/analyze
Content-Type: application/json

{
    "strategy_name": "momentum_strategy",
    "parameters": {},
    "start_date": "2023-01-01",
    "end_date": "2023-12-31",
    "initial_capital": 100000.0
}
```

#### 2. è·å–å¯ç”¨ç­–ç•¥
```http
GET /api/v1/quantitative/strategies
```

#### 3. è·å–ç­–ç•¥ä¿¡æ¯
```http
GET /api/v1/quantitative/strategies/momentum_strategy
```

### å¥åº·æ£€æŸ¥æ¥å£

#### 1. ç³»ç»Ÿå¥åº·æ£€æŸ¥
```http
GET /api/v1/health/
```

#### 2. APIä¿¡æ¯
```http
GET /api/v1/health/info
```

## ğŸ›ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„
- **APIå±‚** (`app/api/`): å¤„ç†HTTPè¯·æ±‚å’Œå“åº”
- **æœåŠ¡å±‚** (`app/services/`): ä¸šåŠ¡é€»è¾‘å¤„ç†
- **æ¨¡å‹å±‚** (`app/models/`): æ•°æ®æ¨¡å‹å®šä¹‰
- **æ ¸å¿ƒå±‚** (`app/core/`): é…ç½®å’Œå®‰å…¨
- **å·¥å…·å±‚** (`app/utils/`): é€šç”¨å·¥å…·å‡½æ•°

### è®¾è®¡æ¨¡å¼
- **ä¾èµ–æ³¨å…¥**: ä½¿ç”¨FastAPIçš„Dependsè¿›è¡Œä¾èµ–ç®¡ç†
- **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„å±‚æ¬¡åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤å’Œæµ‹è¯•
- **é…ç½®ç®¡ç†**: ä½¿ç”¨Pydantic Settingsè¿›è¡Œé…ç½®ç®¡ç†
- **æ—¥å¿—è®°å½•**: ç»Ÿä¸€çš„æ—¥å¿—è®°å½•å’Œç®¡ç†
- **å¼‚å¸¸å¤„ç†**: å…¨å±€å¼‚å¸¸å¤„ç†æœºåˆ¶

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
åˆ›å»º `.env` æ–‡ä»¶æ¥è¦†ç›–é»˜è®¤é…ç½®ï¼š

```env
# åº”ç”¨é…ç½®
APP_NAME=CSMAR API
DEBUG=true
HOST=0.0.0.0
PORT=8000

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key-here

# å¤–éƒ¨APIé…ç½®
STOCK_DATA_API_URL=https://api.example.com
STOCK_DATA_API_KEY=your-api-key
```

### é…ç½®ç±»
æ‰€æœ‰é…ç½®éƒ½åœ¨ `app/core/config.py` ä¸­å®šä¹‰ï¼Œæ”¯æŒç¯å¢ƒå˜é‡è¦†ç›–ã€‚

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ–°ç‰ˆæœ¬APIæµ‹è¯•
python test_new_api.py

# è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆå¾…å®ç°ï¼‰
pytest tests/unit/

# è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆå¾…å®ç°ï¼‰
pytest tests/integration/
```

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„APIç«¯ç‚¹
1. åœ¨ `app/api/v1/endpoints/` ä¸­åˆ›å»ºæ–°çš„ç«¯ç‚¹æ–‡ä»¶
2. åœ¨ `app/main.py` ä¸­æ³¨å†Œè·¯ç”±
3. æ·»åŠ ç›¸åº”çš„æ•°æ®æ¨¡å‹å’ŒæœåŠ¡

### æ·»åŠ æ–°çš„æœåŠ¡
1. åœ¨ `app/services/` ä¸­åˆ›å»ºæ–°çš„æœåŠ¡æ¨¡å—
2. å®ç°ç›¸åº”çš„ä¸šåŠ¡é€»è¾‘
3. åœ¨APIç«¯ç‚¹ä¸­ä½¿ç”¨ä¾èµ–æ³¨å…¥

### æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹
1. åœ¨ `app/models/schemas/` ä¸­å®šä¹‰è¯·æ±‚/å“åº”æ¨¡å‹
2. åœ¨ `app/models/entities/` ä¸­å®šä¹‰å®ä½“æ¨¡å‹
3. åœ¨æœåŠ¡ä¸­ä½¿ç”¨è¿™äº›æ¨¡å‹

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—è®°å½•
- ä½¿ç”¨ `app/utils/logger.py` è¿›è¡Œæ—¥å¿—è®°å½•
- æ”¯æŒæ§åˆ¶å°å’Œæ–‡ä»¶è¾“å‡º
- å¯é…ç½®æ—¥å¿—çº§åˆ«

### å¥åº·æ£€æŸ¥
- æä¾›å¤šä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹
- ç›‘æ§å„ä¸ªæœåŠ¡çš„çŠ¶æ€
- æ”¯æŒè¯¦ç»†çš„ç³»ç»Ÿä¿¡æ¯

## ğŸš€ éƒ¨ç½²

### Dockeréƒ¨ç½²ï¼ˆå¾…å®ç°ï¼‰
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "main.py"]
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®
- è®¾ç½® `DEBUG=false`
- é…ç½®é€‚å½“çš„æ—¥å¿—çº§åˆ«
- è®¾ç½®å®‰å…¨å¯†é’¥
- é…ç½®æ•°æ®åº“è¿æ¥

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥å¤„ç†
- ä½¿ç”¨FastAPIçš„å¼‚æ­¥ç‰¹æ€§
- æ•°æ®åº“æ“ä½œå¼‚æ­¥åŒ–
- å¤–éƒ¨APIè°ƒç”¨å¼‚æ­¥åŒ–

### ç¼“å­˜ç­–ç•¥
- Redisç¼“å­˜ï¼ˆå¾…å®ç°ï¼‰
- å†…å­˜ç¼“å­˜
- æŸ¥è¯¢ç»“æœç¼“å­˜

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### è®¤è¯å’Œæˆæƒ
- JWTä»¤ç‰Œè®¤è¯
- å¯†ç åŠ å¯†
- æƒé™æ§åˆ¶

### æ•°æ®éªŒè¯
- Pydanticæ¨¡å‹éªŒè¯
- è¾“å…¥å‚æ•°éªŒè¯
- è¾“å‡ºæ•°æ®éªŒè¯

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- åˆ›å»ºIssue
- å‘é€é‚®ä»¶
- æäº¤Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚
